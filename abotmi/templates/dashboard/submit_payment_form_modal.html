{% load staticfiles %}
{% load widget_tweaks %}
<link href="/static/css/datetimepicker.css" type="text/css" media="all" rel="stylesheet">
<div class="modal fade upwardz-modal" id="crisil_transaction" name="crisil_transaction" tabindex="-1" role="dialog" labelledby="myLargeModalLabel" style="display:none;" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="panel panel-default upwrdz-log-panel">
            <div class="modal-header modal-header-border-bottom text-center">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <i class="fa fa-times-thin fa-2x"></i>
                </button>
                <h3 class="modal-title n-span-blue-color">CVA APPLICATION PAYMENT DETAILS</h3>
                <hr class="modal-heading-hr">
            </div>
            <div class="panel-body pannel-popup-content" id="crisil_transaction-body">
                <div id="payment_option" class="col-md-offset-3 col-md-6">
                    <p class="text-center">
                        <div class="alert alert-danger hide" role="alert" id="error_payment_block"></div>
                        <div class="form-group">
                            <label for="exampleInputName2">Please select the Payment type:</label>
                            <select class="form-control" name="payment_option" id="id_payment_option">
                                <option value="">Select</option>
                                <option value="offline">Offline</option>
                                <option value="online">Online</option>
                            </select>
                            <span class="help-block" id="help_payment_option"></span>
                        </div>
                    </p>
                    <div class="text-center">
                        <button type="button" id="id_submit_payment_option" class="btn btn-default upwrdz-button" onclick="submit_payment_option();">Ok</button>
                    </div>
                </div>
                {{ payment_form.media }}
                <div class="col-md-12" id="offline_payment_div" style="display:none;">
                    <div class="row">
                    <form class="form-horizontal" id="payment_form" name="payment_form" method="post" action="/dashboard/load_payment_form/" enctype="multipart/form-data">

                        <div class="col-md-offset-1 col-sm-12 col-md-9">
                            <div class="row">
                            {% for field in payment_form %}
                                <div class="form-group">
                                    <label for="inputEmail3" class="col-sm-2 col-md-4 control-label" id="{{field.id_for_label}}_label">{{ field.label }}</label>
                                    <div class="col-sm-10 col-md-8">
                                        {% if field.label == 'Amount' %}
                                            <div class="control">
                                            {% render_field field class+="form-control input" placeholder=field.label %}<span class="tax-text">Including All Taxes.</span>
                                            </div>
                                            <span class="help-block" id="{{field.label}}"></span>
                                        {% elif field.label == 'Reference Document' %}
                                            <div class="control" style="display:inline-block;">
                                            {% render_field field class+="form-control input" placeholder=field.label %}
                                            </div><i class="glyphicon glyphicon-question-sign cursor-pointer" onclick="toggle_paymeny_div();" style="padding-left:5px;margin-left:1px;"></i>
                                            <span class="help-block" id="{{field.label}}"></span>
                                        {% elif field.label == 'Years Selected' %}
                                            <div class="control">
                                                {% render_field field class+="form-control input" placeholder=field.label %}
                                            </div>
                                        {% else %}
                                            <div class="control">
                                            {% render_field field class+="form-control input" placeholder=field.label %}
                                            </div>
                                            <span class="help-block" id="{{field.label}}"></span>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endfor %}
                            <div class="form-horizontal payment_information col-md-offset-2 col-md-8 col-sm-12">
                                <label class="col-sm-2 col-md-5 control-label">Mode of Payment</label>
                                <div class="col-sm-10 col-md-7">
                                    <p class="form-control-static">Relevant document to be uploaded</p>
                                </div>
                                <label class="col-sm-2 col-md-5 control-label">Cash Deposit</label>
                                <div class="col-sm-10 col-md-7">
                                    <p class="form-control-static">Challan received from the bank</p>
                                </div>
                                <label class="col-sm-2 col-md-5 control-label">RTGS/NEFT</label>
                                <div class="col-sm-10 col-md-7">
                                    <p class="form-control-static">Acknowledgement from bank</p>
                                </div>
                                <label class="col-sm-2 col-md-5 control-label">Cheque/DD</label>
                                <div class="col-sm-10 col-md-7">
                                    <p class="form-control-static">Scanned copy of Cheque/DD.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="col-md-offset-2 col-md-9 col-sm-12">
                            <div class="col-sm-5">
                                <button type="button" class="btn btn-default upwrdz-button-bottom upwrdz-button btn-block" id="id_cancel_transaction" data-dismiss="modal" onclick="$('.input').val('');">
                                    Cancel
                                </button>
                            </div>
                            <div class="col-sm-5">
                                <button type="button" class="btn btn-default upwrdz-button-bottom upwrdz-button btn-block" id="id_re_transaction_details" onclick="submit_bank_details();">
                                    Submit
                                </button>
                            </div>
                        </div>
                    </form>
                    </div>
                </div>
                <div class="col-md-12 hide" id="online_payment_div">
                    <form class="form-horizontal" action="/dashboard/crisil_online_payment/" method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label class="col-sm-3 col-lg-6 col-md-6 control-label">Amount</label>
                            <div class="col-sm-9 col-lg-6 col-md-6">
                                <p class="form-control-static">:&nbsp; {{transaction_details.discounted_amount}}</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-3 col-lg-6 col-md- control-label">No of Years Selected</label>
                            <div class="col-sm-9 col-lg-6 col-md-">
                                <p class="form-control-static">:&nbsp; {{no_of_years_selected}}</p>
                            </div>
                        </div>
                        <div class="col-md-offset-2 col-md-10">
                            <div class="col-md-5">
                                <button type="button" name="button" class="btn upwrdz-button btn-block" data-dismiss="modal">Cancel</button>
                            </div>
                            <div class="col-md-5">
                                <button type="submit" name="button" class="btn upwrdz-button btn-block">Submit</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="crisil_thanks_payment_information" style="display:none;">
    <p class="text-center">
        Thank you for providing Details
    </p>
    <div class="text-center">
        <button type="button" id="id_crisil_button" class="btn btn-default upwrdz-button" onclick="window.location.reload();">Ok</button>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function(){
        $('#id_description').val('{{no_of_years_selected}}');
        $("input[name='cheque_dd_date']").attr("readonly", false);
        $("#input[name='cheque_dd_date']").on('keypress', function(e) {
            e.preventDefault(); // Don't allow direct editing
        });
        if( $('#id_promo_code').val() != ''){
            $('#id_promo_code').attr('readonly',true);
        }
        $("#id_amount_label").css('display','none');
    });
    $("#id_scaned_doc").change(function() {
        if($("#id_scaned_doc").val()!=''){
            document.getElementById('Reference Document').innerHTML = '';
        }
    });
    $("#id_amount").change(function() {
        if($("#id_amount").val()!=''){
            document.getElementById('Enter Amount').innerHTML = '';
        }
        if($("#id_amount").val() < 100 || $("#id_amount").val() > 50000){
            document.getElementById('Enter Amount').innerHTML = 'Enter Amount above 100 INR below 50000 INR';
        }
    });
    $("#id_cheque_dd_date").change(function() {
        if($("input[name='cheque_dd_date']").val()!=''){
            document.getElementById('Date of Payment').innerHTML = '';
        }
    });
    $("#id_cheque_dd_no").change(function() {
        if($("#id_cheque_dd_no").val()!=''){
            document.getElementById('Reference Number').innerHTML = '';
        }
    });
    $("#id_bank_name").change(function() {
        if($("#id_bank_name").val() != ''){
            document.getElementById('Bank Name').innerHTML = '';
        }
    });

    function submit_bank_details(){
        var check_data = ['#id_scaned_doc','#id_amount','input[name="cheque_dd_date"]','#id_cheque_dd_no','#id_bank_name'];
        var null_fields = 0;
        for (i=0; i<=check_data.length; i++){
            var value = $(check_data[i]).val();
            if(value == ''){
                if(check_data[i] == 'input[name="cheque_dd_date"]'){
                    document.getElementById('Date of Payment').innerHTML = 'Please Enter Date of Payment';
                    null_fields = 1;
                }
                if(check_data[i] == '#id_scaned_doc'){
                    document.getElementById('Reference Document').innerHTML = 'Please upload payment Softcopy';
                    null_fields = 1;
                }
                else{
                    var placeholder = $(check_data[i]).attr("placeholder");
                    if(placeholder != null || placeholder != 'unable to save data' || placeholder !=''){
                        document.getElementById(placeholder).innerHTML = 'Please Enter '+placeholder;
                        null_fields = 1;
                    }
                }
                $(check_data[i]).focus();
            }
        }
        if(null_fields == 0){
            $("#id_re_transaction_details").html('Please Wait ....');
            $("#id_re_transaction_details").prop('disabled',true);
            $("#id_cancel_transaction").prop('disabled',true);
            var form_data = new FormData($('#payment_form')[0]);
            var token = "{{ csrf_token }}";
            $.ajax({
                type: 'POST',
                url : '/dashboard/submit_crisil_form/',
                beforeSend: function(request){
                    request.setRequestHeader("X-CSRFToken", token);
                },
                data: form_data,
                cache: false,
                processData: false,
                contentType: false,
                success:function(response){
                    if(response=='success'){
                        var thanks_information = $("#crisil_thanks_payment_information").html();
                        $('#crisil_transaction-body').html('');
                        $("#crisil_transaction-body").html(thanks_information);
                    } else {
                        alert('unable to save data');
                    }
                }
            });
        }
    }
    function enable_cheque_dd_date(){
        $('input[name="cheque_dd_date"]').prop('readonly', true);
    }

    function disable_cheque_dd_date(){
        $('input[name="cheque_dd_date"]').prop('readonly', false);
    }
    function toggle_paymeny_div() {
        $('.payment_information').toggle();
    }
    // submit crisil form after selecting the payment option
    function submit_payment_option() {
        var payment_type_option = $("#id_payment_option").val();
        if(payment_type_option != ''){
            $("#help_payment_option").html('');
            if(payment_type_option == 'offline'){
                $('#payment_option').css('display', 'none');
                $("#offline_payment_div").css('display', 'block');
            }else{
                $.ajax({
                    type: 'POST',
                    url: '/dashboard/check_ebs_mandatory_details/',
                    beforeSend: function(request) {
                        request.setRequestHeader("X-CSRFToken", token);
                    },
                    data:{},
                    success: function (response){
                        if(response == 'success'){
                            $('#payment_option').css('display', 'none');
                            $("#online_payment_div").removeClass('hide');
                        }else{
                            $("#error_payment_block")
                                .html('Please fill Mobile Number, City, Pincode, Address \n For filling details Please click this <a href="/signup/personal_information/"><u style="color:blue;">link</u></a>')
                                .removeClass('hide');
                        }
                    },
                    error: function (response) {
                        alert('Unable to process online payment cureently.');
                    }
                })
            }
        }else{
            $("#help_payment_option").html('Please Select the Payment Option');
        }
    }
</script>
<script src="/static/js/WearProtection.js" type="text/javascript"></script>
